name: "ðŸŽ® PSVita Builds"
on: [push, pull_request]

env:
  GODOT_BRANCH: 3.x
  VITASDK_DIR: /usr/local/vitasdk
  VDPM_COMMIT: 426032a2fd05300cf9ef04e5f691f07f642c14cf
  VITA_PACKAGES_EXTRA_COMMIT: 6000b5630c3a7fc2fb368293dd35560bd2e72e0f
  EUID: 1

concurrency:
  group: ci-${{ github.actor }}-${{ github.head_ref || github.run_number }}-${{ github.ref }}-vita
  cancel-in-progress: true

jobs:
  vita-template:
    runs-on: ubuntu-22.04
    name: Vita Template Build

    steps:
      # 1. Checkout with submodules
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. Restore SCons cache
      - name: Restore SCons cache
        uses: ./.github/actions/godot-cache-restore
        with:
          cache-name: vita-template
        continue-on-error: true

      # 3. Setup Python & SCons
      - name: Setup Python & SCons
        uses: ./.github/actions/godot-deps

      # 4. Install system dependencies
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            cmake libarchive-tools fakeroot zip wget libelf-dev build-essential \
            libxcursor-dev libx11-dev libxext-dev libxfixes-dev libxi-dev \
            libxinerama-dev libxrender-dev libxrandr-dev libgl1-mesa-dev libglu1-mesa-dev \
            git-core python3 make autoconf texinfo bison flex libtool

      # 5. Install VitaSDK (fat build with all portlibs)
      - name: Install VitaSDK (Fat Build)
        run: |
          # Remove any previous SDK
          sudo rm -rf $VITASDK_DIR
          # Clone vdpm and pin to 2024 commit
          git clone https://github.com/vitasdk/vdpm
          cd vdpm
          git checkout $VDPM_COMMIT
          # Export VITASDK for bootstrap & install scripts
          export VITASDK=$VITASDK_DIR
          echo "VITASDK=$VITASDK_DIR" >> $GITHUB_ENV
          # Ensure vdpm scripts see the toolchain location
          export PATH=$VITASDK/bin:$PATH
          echo "$VITASDK/bin" >> $GITHUB_PATH
          # Bootstrap & build the full SDK
          ./bootstrap-vitasdk.sh
          ./install-all.sh
          # Verify installation
          arm-vita-eabi-gcc --version

      # 6. Install vita-packages-extra (PVR_PSP2)
      - name: Install Vita Packages Extra
        run: |
          export PATH=$VITASDK_DIR/bin:$PATH
          git clone https://github.com/isage/vita-packages-extra
          cd vita-packages-extra
          git checkout $VITA_PACKAGES_EXTRA_COMMIT
          cd pvr_psp2
          vita-makepkg
          ../../vdpm/vdpm *-arm.tar.xz
          echo "âœ… VitaSDK extra packages installed"

      # 7. Prepare SCons cache
      - name: Prepare SCons cache
        run: |
          rm -rf .sconf_temp .scons-cache
          mkdir -p .sconf_temp .scons-cache
          chmod -R 777 .sconf_temp .scons-cache

      # 8. Compile Godot for Vita
      - name: Compile Godot for Vita
        id: compilation
        run: |
          export PATH=$VITASDK_DIR/bin:$PATH
          export SCONS_CACHE_DIR="$GITHUB_WORKSPACE/.scons-cache"
          echo "ðŸ”¨ Building with external libraries"
          if scons \
               platform=vita target=release tools=false \
               verbose=no warnings=no werror=no debug_symbols=no \
               use_rtti=True disable_gles3=True \
               cache_dir=$SCONS_CACHE_DIR \
               builtin_zstd=no \
               builtin_zlib=no \
               builtin_pcre2=yes \
               CC="arm-vita-eabi-gcc -marm -Wno-psabi" \
               CXX="arm-vita-eabi-g++ -marm -Wno-psabi" \
               LINK="arm-vita-eabi-g++ -marm -Wno-psabi" \
               LINKFLAGS="-marm -mno-thumb-interwork"; then
            echo "âœ… Build succeeded"
            echo "BUILD_RESULT=success" >> $GITHUB_ENV
          else
            echo "âŒ Build failed"
            echo "BUILD_RESULT=failed" >> $GITHUB_ENV
            exit 1
          fi

      # 9. Manual VELF Creation
      - name: Manual VELF Creation
        if: env.BUILD_RESULT == 'success'
        run: |
          cd temp-build
          cp godot.vita.opt.32 vita_release_stripped
          arm-vita-eabi-strip -g vita_release_stripped
          vita-elf-create vita_release_stripped vita_release.velf
          echo "âœ… VELF created"

      # 10. Package PS Vita template
      - name: Package Complete PS Vita Template
        if: env.BUILD_RESULT == 'success'
        run: |
          mkdir -p template_build/vita_release/module template_build/vita_release/sce_sys/livearea/contents
          cp temp-build/vita_release.velf template_build/vita_release/
          vita-make-fself temp-build/vita_release.velf template_build/vita_release/eboot.bin
          find vita-packages-extra/pvr_psp2/dist -name '*.suprx' \
            -exec cp {} template_build/vita_release/module/ \;
          cat > template_build/vita_release/sce_sys/livearea/contents/template.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <livearea style="a1" format-ver="01.00" content-rev="1">
            <livearea-background><image>bg0.png</image></livearea-background>
            <gate><startup-image>startup.png</startup-image></gate>
          </livearea>
          EOF
          touch template_build/vita_release/sce_sys/param.sfo template_build/vita_release/sce_sys/icon0.png
          cd template_build
          zip -r ../vita_release.zip vita_release
          cd ..
          zip -r vita-template.zip vita_release.zip
          echo "âœ… Complete template: vita-template.zip"

      # 11. Save build cache
      - name: Save Godot build cache
        uses: ./.github/actions/godot-cache-save
        with:
          cache-name: vita-template
        continue-on-error: true

      # 12. Upload artifacts
      - name: Upload PSVita Template
        uses: actions/upload-artifact@v4
        with:
          name: vita-template-${{ github.sha }}
          path: |
            vita-template.zip
            vita_release.zip

      # 13. Debug info
      - name: Debug Info
        if: always()
        run: |
          echo "=== Vita Build Summary ==="
          lsb_release -d
          arm-vita-eabi-gcc --version
          ls -la temp-build template_build
          du -sh .scons-cache || true
          echo "=== VitaSDK include ==="
          ls -1 $VITASDK_DIR/arm-vita-eabi/include | head -20
          echo "=== VitaSDK lib ==="
          ls -1 $VITASDK_DIR/arm-vita-eabi/lib | head -20
