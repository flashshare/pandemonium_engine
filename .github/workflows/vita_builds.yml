name: "ðŸŽ® PSVita Builds"
on: [push, pull_request]

env:
  VITASDK_DIR: /usr/local/vitasdk
  VITASDK_TAR: vitasdk-x86_64-linux-gnu-2024-08-09_11-28-39.tar.bz2
  VITASDK_URL: https://github.com/vitasdk/autobuilds/releases/download/master-linux-v2.527
  VDPM_COMMIT: 426032a2fd05300cf9ef04e5f691f07f642c14cf
  VITA_PACKAGES_EXTRA_COMMIT: 6000b5630c3a7fc2fb368293dd35560bd2e72e0f

jobs:
  vita-template:
    runs-on: ubuntu-22.04
    concurrency:
      group: ci-${{github.actor}}-${{github.ref}}-vita
      cancel-in-progress: true

    steps:
    - uses: actions/checkout@v4
      with: {submodules: recursive}

    - uses: ./.github/actions/godot-deps              # Python + SCons

    - name: APT build-deps
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y cmake libarchive-tools fakeroot zip \
          wget libelf-dev build-essential libxcursor-dev libx11-dev \
          libxext-dev libxfixes-dev libxi-dev libxinerama-dev \
          libxrender-dev libxrandr-dev libgl1-mesa-dev libglu1-mesa-dev

    # ----------------------- VitaSDK install -----------------------------
    - name: Install VitaSDK (Aug 2024)
      run: |
        sudo rm -rf $VITASDK_DIR
        sudo mkdir -p $VITASDK_DIR
        wget -q "$VITASDK_URL/$VITASDK_TAR" -O sdk.tar.bz2
        sudo tar --strip-components=1 -xf sdk.tar.bz2 -C $VITASDK_DIR
        sudo chown -R $USER:$USER $VITASDK_DIR
        echo "$VITASDK_DIR/bin" >> $GITHUB_PATH
        arm-vita-eabi-gcc --version

    - name: VDPM packages (no PCRE2)
      run: |
        export PATH=$VITASDK_DIR/bin:$PATH
        git clone https://github.com/vitasdk/vdpm
        cd vdpm
        git checkout $VDPM_COMMIT
        chmod +x vdpm
        # core libs only â€“ NO pcre2
        ./vdpm -f taihen libdl libogg libzstd theora opus jpeg png z
        ./vdpm -f vita-rss-libdl
        cd ..
        git clone https://github.com/isage/vita-packages-extra
        cd vita-packages-extra
        git checkout $VITA_PACKAGES_EXTRA_COMMIT
        cd pvr_psp2
        vita-makepkg
        ../../vdpm/vdpm *-arm.tar.xz

    # ----------------------- Build --------------------------------------
    - name: Compile Godot (pure ARM, builtin PCRE2)
      run: |
        export PATH=$VITASDK_DIR/bin:$PATH
        scons platform=vita target=release tools=false \
              verbose=no warnings=no werror=no debug_symbols=no \
              use_rtti=True disable_gles3=True builtin_pcre2=yes \
              CC="arm-vita-eabi-gcc -marm -Wno-psabi" \
              CXX="arm-vita-eabi-g++ -marm -Wno-psabi" \
              LINK="arm-vita-eabi-g++ -marm -Wno-psabi" \
              LINKFLAGS="-marm -mno-thumb-interwork" \
              cache_dir=.scons-cache

    - name: VELF conversion
      run: |
        cd temp-build
        cp godot.vita.opt.32 vita_release_stripped
        arm-vita-eabi-strip -g vita_release_stripped
        vita-elf-create vita_release_stripped vita_release.velf

    - name: Package PS Vita template
      run: |
        mkdir -p template/vita_release/module \
                 template/vita_release/sce_sys/livearea/contents
        vita-make-fself temp-build/vita_release.velf \
                        template/vita_release/eboot.bin
        find vita-packages-extra/pvr_psp2/dist -name '*.suprx' -exec \
             cp {} template/vita_release/module/ \;
        touch template/vita_release/sce_sys/param.sfo \
              template/vita_release/sce_sys/icon0.png
        cat > template/vita_release/sce_sys/livearea/contents/template.xml <<'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <livearea style="a1" format-ver="01.00" content-rev="1">
          <livearea-background><image>bg0.png</image></livearea-background>
          <gate><startup-image>startup.png</startup-image></gate>
        </livearea>
        EOF
        (cd template && zip -r ../vita-template.zip vita_release)

    - uses: actions/upload-artifact@v4
      with:
        name: vita-template-${{ github.sha }}
        path: vita-template.zip
