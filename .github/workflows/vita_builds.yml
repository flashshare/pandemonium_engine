name: "ðŸŽ® PSVita Build"
on: [push, pull_request]

env:
  GODOT_BRANCH: 3.x
  VITASDK_DIR: /usr/local/vitasdk
  VITASDK_TAR: vitasdk-x86_64-linux-gnu-2024-08-09_11-28-39.tar.bz2
  VITASDK_URL: https://github.com/vitasdk/autobuilds/releases/download/master-linux-v2.527
  EXTRA_COMMIT: d5b66fa7271abac9689541a59110adc17d06a616

jobs:
  vita:
    runs-on: ubuntu-22.04
    concurrency:
      group: ci-${{github.ref}}-vita
      cancel-in-progress: true

    steps:
    - uses: actions/checkout@v4
      with: {submodules: recursive}

    - uses: actions/cache@v4
      id: cache-restore
      with:
        path: .scons-cache
        key: scons-vita-${{github.ref}}-${{github.sha}}
        restore-keys: |
          scons-vita-${{github.ref}}
          scons-vita

    - name: Set-up Python & SCons
      uses: ./.github/actions/godot-deps

    - name: APT dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y cmake fakeroot zip wget libelf-dev build-essential \
          libxcursor-dev libx11-dev libxext-dev libxfixes-dev libxi-dev \
          libxinerama-dev libxrender-dev libxrandr-dev libgl1-mesa-dev libglu1-mesa-dev

    - name: Install VitaSDK (Aug 2024)
      run: |
        sudo rm -rf ${{env.VITASDK_DIR}}
        wget -q "${{env.VITASDK_URL}}/${{env.VITASDK_TAR}}"
        sudo tar -xf "${{env.VITASDK_TAR}}" -C /usr/local/
        sudo chown -R $USER:$USER ${{env.VITASDK_DIR}}
        
        # Export PATH immediately for this step
        export VITASDK=${{env.VITASDK_DIR}}
        export PATH=$VITASDK/bin:$PATH
        
        # Persist for later steps
        echo "VITASDK=${{env.VITASDK_DIR}}" >> $GITHUB_ENV
        echo "${{env.VITASDK_DIR}}/bin" >> $GITHUB_PATH
        
        # Now arm-vita-eabi-gcc is available
        arm-vita-eabi-gcc --version

    - name: Bootstrap vdpm & install packages
      run: |
        export VITASDK=${{env.VITASDK_DIR}}
        export PATH=$VITASDK/bin:$PATH
        
        git clone https://github.com/vitasdk/vdpm
        cd vdpm
        chmod +x vdpm
        ./bootstrap-vitasdk.sh
        ./install-all.sh
        ./vdpm -f taihen pvr_psp2 libdl libogg libzstd libpcre2-32 theora opus jpeg png z
        ./vdpm vita-rss-libdl
        echo "vdpm list:" && ./vdpm -l | head

    - name: Prepare SCons dirs
      run: |
        mkdir -p .sconf_temp .scons-cache
        chmod -R 777 .sconf_temp .scons-cache

    - name: Compile Godot (PS Vita)
      env:
        SCONS_CACHE: .scons-cache
        SCONS_CACHE_LIMIT: 7168
      run: |
        export VITASDK=${{env.VITASDK_DIR}}
        export PATH=$VITASDK/bin:$PATH
        
        scons --no-dry-run \
          p=vita target=release tools=no \
          verbose=no warnings=no werror=no debug_symbols=no \
          use_rtti=yes disable_gles3=yes \
          CCFLAGS="-marm -mno-thumb-interwork" \
          CXXFLAGS="-marm -mno-thumb-interwork" \
          LINKFLAGS="-marm"

    - uses: actions/cache@v4
      if: always()
      with:
        path: .scons-cache
        key: scons-vita-${{github.ref}}-${{github.sha}}

    - name: Upload PS Vita template
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: vita-template-${{github.sha}}
        path: |
          temp-build/vita_release/
          temp-build/vita_release.velf
          temp-build/godot.vita.opt.32

    - name: Debug info
      if: always()
      run: |
        export VITASDK=${{env.VITASDK_DIR}}
        export PATH=$VITASDK/bin:$PATH
        
        echo "=== Runner ==="; lsb_release -d
        echo "=== VitaSDK ==="; arm-vita-eabi-gcc --version | head -1
        echo "=== Build outputs ==="
        ls -R temp-build || true
        echo "Cache size:"; du -sh .scons-cache || true
