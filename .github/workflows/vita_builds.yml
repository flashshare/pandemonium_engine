name: ðŸŽ® PSVita Buildsâ€¢ Choice A
on: [push, pull_request]

env:
  GODOT_BASE_BRANCH: 3.x
  SCONSFLAGS: verbose=no warnings=no werror=no debug_symbols=no \
              use_rtti=True disable_gles3=True disable_exceptions=yes
  VITASDK: /usr/local/vitasdk
  VDPM_COMMIT: 426032a2fd05300cf9ef04e5f691f07f642c14cf
  VITA_PACKAGES_EXTRA_COMMIT: 6000b5630c3a7fc2fb368293dd35560bd2e72e0f
  SDK_URL: https://github.com/vitasdk/autobuilds/releases/download/master-linux-v2.529/\
vitasdk-x86_64-linux-gnu-2025-03-11_15-12-52.tar.bz2     # pinned SDK
  EUID: 1

concurrency:
  group: ci-${{github.actor}}-${{github.head_ref || github.run_number}}-${{github.ref}}-vita
  cancel-in-progress: true

jobs:
  vita-template:
    runs-on: ubuntu-24.04
    name: PS Vita template (build-in-place)

    steps:
    - uses: actions/checkout@v4
      with: {submodules: recursive}

    - uses: ./.github/actions/godot-cache-restore
      continue-on-error: true

    - uses: ./.github/actions/godot-deps    # Python + SCons

    - name: Install host packages
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y cmake libarchive-tools fakeroot zip \
          git-core python3 make autoconf texinfo bison flex libtool

    - name: Install VitaSDK (March 2025 + all portlibs)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        sudo rm -rf "$VITASDK"
        git clone https://github.com/vitasdk/vdpm
        cd vdpm && git checkout $VDPM_COMMIT

        # authenticated fetch prevents rate-limit and pins exact SDK
        ./bootstrap-vitasdk.sh -u "$SDK_URL"
        ./install-all.sh                        # taihen, zstd, etc.

        export PATH=$VITASDK/bin:$PATH
        ./vdpm -f vita-rss-libdl                # extra stub
        cd ..

        # PVR_PSP2 drivers
        git clone https://github.com/isage/vita-packages-extra
        cd vita-packages-extra && git checkout $VITA_PACKAGES_EXTRA_COMMIT
        cd pvr_psp2 && vita-makepkg
        ../../vdpm/vdpm *-arm.tar.xz

    - name: Build Godot (Vita export)
      uses: ./.github/actions/godot-build
      with:
        sconsflags: ${{ env.SCONSFLAGS }}
        platform: vita
        target: release
        tools: false

    - uses: ./.github/actions/godot-cache-save
      with: {cache-name: vita-template}
      continue-on-error: true

    - uses: ./.github/actions/upload-artifact
      with:
        name: vita-template-${{ github.sha }}
        path: bin/vita_release.zip
