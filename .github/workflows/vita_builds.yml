name: "ðŸŽ® PSVita Builds"
on: [push, pull_request]

env:
  GODOT_BRANCH: 3.x
  VITASDK_DIR: /usr/local/vitasdk
  VITASDK_TAR: vitasdk-x86_64-linux-gnu-2024-08-09_11-28-39.tar.bz2
  VITASDK_URL: https://github.com/vitasdk/autobuilds/releases/download/master-linux-v2.527
  VDPM_COMMIT: 426032a2fd05300cf9ef04e5f691f07f642c14cf
  VITA_PACKAGES_EXTRA_COMMIT: 6000b5630c3a7fc2fb368293dd35560bd2e72e0f
  EUID: 1

concurrency:
  group: ci-${{github.actor}}-${{github.head_ref || github.run_number}}-${{github.ref}}-vita
  cancel-in-progress: true

jobs:
  vita-template:
    runs-on: ubuntu-22.04
    name: Vita Template Build

    steps:
      - uses: actions/checkout@v4
        with: { submodules: recursive }

      - name: Restore SCons cache
        uses: ./.github/actions/godot-cache-restore
        with: { cache-name: vita-template }
        continue-on-error: true

      - name: Setup Python & SCons
        uses: ./.github/actions/godot-deps

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            cmake libarchive-tools fakeroot zip wget libelf-dev build-essential \
            libxcursor-dev libx11-dev libxext-dev libxfixes-dev libxi-dev \
            libxinerama-dev libxrender-dev libxrandr-dev libgl1-mesa-dev libglu1-mesa-dev

      - name: Install VitaSDK (Aug 2024)
        run: |
          sudo rm -rf $VITASDK_DIR
          sudo mkdir -p $VITASDK_DIR
          wget -q "$VITASDK_URL/$VITASDK_TAR" -O "$VITASDK_TAR"
          sudo tar --strip-components=1 -xf "$VITASDK_TAR" -C $VITASDK_DIR
          sudo chown -R $USER:$USER $VITASDK_DIR
          echo "VITASDK=$VITASDK_DIR" >> $GITHUB_ENV
          echo "$VITASDK_DIR/bin" >> $GITHUB_PATH
          export PATH=$VITASDK_DIR/bin:$PATH
          arm-vita-eabi-gcc --version

      - name: Install VitaSDK packages (essential only)
        run: |
          export PATH=$VITASDK_DIR/bin:$PATH
          git clone https://github.com/vitasdk/vdpm
          cd vdpm
          git checkout $VDPM_COMMIT
          chmod +x vdpm
          # Install minimal required packages for hardware
          ./vdpm -f taihen libdl
          cd ..
          git clone https://github.com/isage/vita-packages-extra
          cd vita-packages-extra
          git checkout $VITA_PACKAGES_EXTRA_COMMIT
          cd pvr_psp2
          vita-makepkg
          ../../vdpm/vdpm *-arm.tar.xz
          echo "âœ… VitaSDK packages installed"

      - name: Prepare SCons cache
        run: |
          rm -rf .sconf_temp .scons-cache
          mkdir -p .sconf_temp .scons-cache
          chmod -R 777 .sconf_temp .scons-cache

      - name: Compile Godot for Vita (all builtin dependencies)
        id: compilation
        run: |
          export PATH=$VITASDK_DIR/bin:$PATH
          export SCONS_CACHE_DIR="$GITHUB_WORKSPACE/.scons-cache"
          echo "ðŸ”¨ Building with all builtin dependencies enabled"
          if scons \
               platform=vita target=release tools=false \
               verbose=no warnings=no werror=no debug_symbols=no \
               use_rtti=True disable_gles3=True \
               cache_dir=$SCONS_CACHE_DIR \
               builtin_brotli=yes \
               builtin_bullet=yes \
               builtin_certs=yes \
               builtin_embree=yes \
               builtin_enet=yes \
               builtin_freetype=yes \
               builtin_glew=yes \
               builtin_graphite=yes \
               builtin_harfbuzz=yes \
               builtin_icu4c=yes \
               builtin_libogg=yes \
               builtin_libpng=yes \
               builtin_libtheora=yes \
               builtin_libvorbis=yes \
               builtin_libvpx=yes \
               builtin_libwebp=yes \
               builtin_mbedtls=yes \
               builtin_miniupnpc=yes \
               builtin_opus=yes \
               builtin_pcre2=yes \
               builtin_zlib=yes \
               builtin_zstd=yes \
               CC="arm-vita-eabi-gcc -marm -Wno-psabi" \
               CXX="arm-vita-eabi-g++ -marm -Wno-psabi" \
               LINK="arm-vita-eabi-g++ -marm -Wno-psabi" \
               LINKFLAGS="-marm -mno-thumb-interwork"; then
            echo "âœ… Build succeeded"
            echo "BUILD_RESULT=success" >> $GITHUB_ENV
          else
            echo "âŒ Build failed"
            echo "BUILD_RESULT=failed" >> $GITHUB_ENV
            exit 1
          fi

      - name: Manual VELF Creation
        if: env.BUILD_RESULT == 'success'
        run: |
          cd temp-build
          cp godot.vita.opt.32 vita_release_stripped
          arm-vita-eabi-strip -g vita_release_stripped
          vita-elf-create vita_release_stripped vita_release.velf
          echo "âœ… VELF created"

      - name: Package Complete PS Vita Template
        if: env.BUILD_RESULT == 'success'
        run: |
          mkdir -p template_build/vita_release/module template_build/vita_release/sce_sys/livearea/contents
          cp temp-build/vita_release.velf template_build/vita_release/
          vita-make-fself temp-build/vita_release.velf template_build/vita_release/eboot.bin
          find vita-packages-extra/pvr_psp2/dist -name '*.suprx' \
            -exec cp {} template_build/vita_release/module/ \;
          cat > template_build/vita_release/sce_sys/livearea/contents/template.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <livearea style="a1" format-ver="01.00" content-rev="1">
            <livearea-background><image>bg0.png</image></livearea-background>
            <gate><startup-image>startup.png</startup-image></gate>
          </livearea>
          EOF
          touch template_build/vita_release/sce_sys/param.sfo template_build/vita_release/sce_sys/icon0.png
          cd template_build
          zip -r ../vita_release.zip vita_release
          cd ..
          zip -r vita-template.zip vita_release.zip
          echo "âœ… Complete template: vita-template.zip"

      - name: Save Godot build cache
        uses: ./.github/actions/godot-cache-save
        with:
          cache-name: vita-template
        continue-on-error: true

      - name: Upload PSVita Template
        uses: actions/upload-artifact@v4
        with:
          name: vita-template-${{ github.sha }}
          path: |
            vita-template.zip
            vita_release.zip

      - name: Debug Info
        if: always()
        run: |
          echo "=== Vita Build Summary ==="
          lsb_release -d
          arm-vita-eabi-gcc --version
          ls -la temp-build template_build
          du -sh .scons-cache || true
