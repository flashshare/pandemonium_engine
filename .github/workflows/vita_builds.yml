name: üéÆ PSVita Builds
on: [push, pull_request]

env:
  GODOT_BASE_BRANCH: 3.x
  VITASDK: /usr/local/vitasdk
  # Use the stable VitaSDK autobuild from August 2022 (GCC 10.x, softfp)
  VITASDK_VERSION: "vitasdk-x86_64-linux-gnu-2022-08-14_14-50-39"
  VITASDK_URL: "https://github.com/vitasdk/buildscripts/releases/download/softfp-linux-v2.228/vitasdk-x86_64-linux-gnu-2022-08-14_14-50-39.tar.bz2"
  # Pin to a known-good vita-packages-extra commit
  VITA_PACKAGES_EXTRA_COMMIT: d5b66fa7271abac9689541a59110adc17d06a616
  EUID: 1

concurrency:
  group: ci-${{github.actor}}-${{github.head_ref || github.run_number}}-${{github.ref}}-vita
  cancel-in-progress: true

jobs:
  vita-release:
    runs-on: ubuntu-24.04
    name: PSVita Release Build

    steps:
      - uses: actions/checkout@v4

      - name: Restore Godot build cache
        uses: ./.github/actions/godot-cache-restore
        continue-on-error: true

      - name: Setup python and scons
        uses: ./.github/actions/godot-deps

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake libarchive-tools fakeroot zip wget libelf-dev

      - name: Setup VitaSDK (2022 GCC 10.x, softfp)
        run: |
          echo "=== Installing VitaSDK Version: $VITASDK_VERSION ==="
          wget -q "$VITASDK_URL"
          sudo tar -xf "${VITASDK_VERSION}.tar.bz2" -C /usr/local/
          sudo chown -R $USER:$USER /usr/local/vitasdk
          export VITASDK=/usr/local/vitasdk
          export PATH=$VITASDK/bin:$PATH
          echo "VITASDK=/usr/local/vitasdk" >> $GITHUB_ENV
          echo "/usr/local/vitasdk/bin" >> $GITHUB_PATH
          echo "=== GCC Version ==="
          arm-vita-eabi-gcc --version

      - name: Setup vdpm and vita-packages-extra libraries (force ABI match)
        run: |
          export VITASDK=/usr/local/vitasdk
          export PATH=$VITASDK/bin:$PATH
          git clone https://github.com/vitasdk/vdpm
          cd vdpm
          # Force rebuild key libraries to ensure ABI compatibility
          vdpm -f libdl
          vdpm -f libogg
          vdpm -f libzstd
          vdpm -f libpcre2-32
          vdpm install-all
          vdpm vita-rss-libdl
          cd ..
          git clone https://github.com/isage/vita-packages-extra
          cd vita-packages-extra
          git checkout $VITA_PACKAGES_EXTRA_COMMIT
          cd pvr_psp2
          # Always pass the ABI flags to guarantee all static libraries match
          export CFLAGS="-mfloat-abi=softfp -mfpu=vfp"
          export CXXFLAGS="-mfloat-abi=softfp -mfpu=vfp"
          export LDFLAGS="-mfloat-abi=softfp -mfpu=vfp"
          vita-makepkg
          vdpm *-arm.tar.xz
          echo "‚úÖ VitaSDK and libraries setup complete"

      - name: Compilation with RTTI, Relocation, and ABI Fixes
        run: |
          export VITASDK=/usr/local/vitasdk
          export PATH=$VITASDK/bin:$PATH
          export CC="arm-vita-eabi-gcc"
          export CXX="arm-vita-eabi-g++"
          export AR="arm-vita-eabi-ar"
          export RANLIB="arm-vita-eabi-ranlib"
          export STRIP="arm-vita-eabi-strip"
          # Build with RTTI, softfp ABI, VFP, non-PIC, non-PIE, and no exceptions/unwind
          scons platform=vita \
                target=release \
                tools=false \
                verbose=no \
                warnings=no \
                werror=no \
                debug_symbols=no \
                use_rtti=True \
                disable_gles3=True \
                CXXFLAGS="-fno-exceptions -fno-unwind-tables -fno-asynchronous-unwind-tables -fno-pic -fno-pie -Wno-psabi -mfloat-abi=softfp -mfpu=vfp" \
                CCFLAGS="-fno-exceptions -fno-unwind-tables -fno-asynchronous-unwind-tables -fno-pic -fno-pie -Wno-psabi -mfloat-abi=softfp -mfpu=vfp" \
                LINKFLAGS="-Wl,--no-eh-frame-hdr -Wl,--gc-sections -Wl,--strip-all -no-pie -mfloat-abi=softfp -mfpu=vfp"
          if [[ ! -f "temp-build/godot.vita.opt.32" ]]; then
            echo "‚ùå ELF not produced. See previous logs!"
            exit 1
          fi
          cp temp-build/godot.vita.opt.32 temp-build/vita_release_stripped
          $VITASDK/bin/arm-vita-eabi-strip -g temp-build/vita_release_stripped
          $VITASDK/bin/vita-elf-create temp-build/vita_release_stripped temp-build/vita_release.velf || {
            echo "‚ùå VELF conversion failed due to invalid relocation."
            exit 1
          }
          echo "‚úÖ Build and VELF conversion complete"

      - name: Save Godot build cache
        uses: ./.github/actions/godot-cache-save
        with:
          cache-name: PSVita Builds
        continue-on-error: true

      - name: Upload artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: godot-vita-release-${{ github.sha }}-stable
          path: |
            temp-build/vita_release.velf
            temp-build/godot.vita.opt.32
            temp-build/vita_release/

      - name: Debug Build Information
        if: always()
        run: |
          echo "=== Build Summary ==="
          arm-vita-eabi-gcc --version || echo "GCC version unknown"
          if [[ -f "temp-build/vita_release.velf" ]]; then
            file temp-build/vita_release.velf
            du -h temp-build/vita_release.velf
          else
            echo "No VELF file produced. Build failure."